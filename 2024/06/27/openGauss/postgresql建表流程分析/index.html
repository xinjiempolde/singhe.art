<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0-rc1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="表的种类">
<meta property="og:type" content="article">
<meta property="og:title" content="postgreSQL建表流程分析">
<meta property="og:url" content="http://example.com/2024/06/27/openGauss/postgresql%E5%BB%BA%E8%A1%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="singheart&#39;s blog">
<meta property="og:description" content="表的种类">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-06-27T12:47:24.000Z">
<meta property="article:modified_time" content="2024-12-11T13:03:57.701Z">
<meta property="article:author" content="singheart">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2024/06/27/openGauss/postgresql%E5%BB%BA%E8%A1%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2024/06/27/openGauss/postgresql%E5%BB%BA%E8%A1%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/","path":"2024/06/27/openGauss/postgresql建表流程分析/","title":"postgreSQL建表流程分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>postgreSQL建表流程分析 | singheart's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">singheart's blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">多读书，多思考</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A1%A8%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="nav-number">1.</span> <span class="nav-text">表的种类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#createstmt"><span class="nav-number">2.</span> <span class="nav-text">CreateStmt</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rangevar"><span class="nav-number">3.</span> <span class="nav-text">RangeVar</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#alias"><span class="nav-number">4.</span> <span class="nav-text">Alias</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#columndef"><span class="nav-number">5.</span> <span class="nav-text">ColumnDef</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#constraint"><span class="nav-number">6.</span> <span class="nav-text">Constraint</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#query"><span class="nav-number">7.</span> <span class="nav-text">Query</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#plannedstmt"><span class="nav-number">8.</span> <span class="nav-text">PlannedStmt</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE%E5%8F%8A%E8%AE%B2%E8%A7%A3"><span class="nav-number">9.</span> <span class="nav-text">流程图及讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#transformcreatestmt"><span class="nav-number">9.1.</span> <span class="nav-text">transformCreateStmt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#definerelation"><span class="nav-number">9.2.</span> <span class="nav-text">DefineRelation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#heap_create_with_catalog"><span class="nav-number">9.3.</span> <span class="nav-text">heap_create_with_catalog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#heap_create"><span class="nav-number">9.4.</span> <span class="nav-text">heap_create</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#relationbuildlocalrelation"><span class="nav-number">9.5.</span> <span class="nav-text">RelationBuildLocalRelation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#relationcreatestorage"><span class="nav-number">9.6.</span> <span class="nav-text">RelationCreateStorage</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="singheart"
      src="http://img.singhe.art/FhsjiuZl1nWUeg6NRdM279QXbA1-">
  <p class="site-author-name" itemprop="name">singheart</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">66</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/xinjiempolde" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xinjiempolde" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/27/openGauss/postgresql%E5%BB%BA%E8%A1%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="http://img.singhe.art/FhsjiuZl1nWUeg6NRdM279QXbA1-">
      <meta itemprop="name" content="singheart">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="singheart's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="postgreSQL建表流程分析 | singheart's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          postgreSQL建表流程分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-06-27 20:47:24" itemprop="dateCreated datePublished" datetime="2024-06-27T20:47:24+08:00">2024-06-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-12-11 21:03:57" itemprop="dateModified" datetime="2024-12-11T21:03:57+08:00">2024-12-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/openGauss/" itemprop="url" rel="index"><span itemprop="name">openGauss</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="表的种类">表的种类</h1>
<span id="more"></span>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_RELATION        <span class="string">&#x27;r&#x27;</span>   <span class="comment">/* ordinary table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_INDEX           <span class="string">&#x27;i&#x27;</span>   <span class="comment">/* secondary index */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_SEQUENCE        <span class="string">&#x27;S&#x27;</span>   <span class="comment">/* sequence object */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_TOASTVALUE      <span class="string">&#x27;t&#x27;</span>   <span class="comment">/* for out-of-line values */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_VIEW            <span class="string">&#x27;v&#x27;</span>   <span class="comment">/* view */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_MATVIEW         <span class="string">&#x27;m&#x27;</span>   <span class="comment">/* materialized view */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_COMPOSITE_TYPE  <span class="string">&#x27;c&#x27;</span>   <span class="comment">/* composite type */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_FOREIGN_TABLE   <span class="string">&#x27;f&#x27;</span>   <span class="comment">/* foreign table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_PARTITIONED_TABLE <span class="string">&#x27;p&#x27;</span> <span class="comment">/* partitioned table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELKIND_PARTITIONED_INDEX <span class="string">&#x27;I&#x27;</span> <span class="comment">/* partitioned index */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELPERSISTENCE_PERMANENT  <span class="string">&#x27;p&#x27;</span> <span class="comment">/* regular table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELPERSISTENCE_UNLOGGED   <span class="string">&#x27;u&#x27;</span> <span class="comment">/* unlogged permanent table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       RELPERSISTENCE_TEMP       <span class="string">&#x27;t&#x27;</span> <span class="comment">/* temporary table */</span></span></span><br><span class="line"><span class="comment">/* default selection for replica identity (primary key or nothing) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       REPLICA_IDENTITY_DEFAULT  <span class="string">&#x27;d&#x27;</span></span></span><br><span class="line"><span class="comment">/* no replica identity is logged for this relation */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       REPLICA_IDENTITY_NOTHING  <span class="string">&#x27;n&#x27;</span></span></span><br><span class="line"><span class="comment">/* all columns are logged as replica identity */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       REPLICA_IDENTITY_FULL     <span class="string">&#x27;f&#x27;</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * an explicitly chosen candidate key&#x27;s columns are used as replica identity.</span></span><br><span class="line"><span class="comment"> * Note this will still be set if the index has been dropped; in that case it</span></span><br><span class="line"><span class="comment"> * has the same meaning as &#x27;n&#x27;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>       REPLICA_IDENTITY_INDEX    <span class="string">&#x27;i&#x27;</span></span></span><br></pre></td></tr></table></figure>
<h1 id="createstmt">CreateStmt</h1>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">CreateStmt</span></span><br><span class="line">&#123;</span><br><span class="line">	NodeTag		type;</span><br><span class="line">	RangeVar   *relation;		<span class="comment">/* relation to create */</span>	</span><br><span class="line">	List	   *tableElts;		<span class="comment">/* column definitions (list of ColumnDef) */</span></span><br><span class="line">	List	   *inhRelations;	<span class="comment">/* relations to inherit from (list of</span></span><br><span class="line"><span class="comment">								 * RangeVar) */</span></span><br><span class="line">	PartitionBoundSpec *partbound;	<span class="comment">/* FOR VALUES clause */</span> </span><br><span class="line">	PartitionSpec *partspec;	<span class="comment">/* PARTITION BY clause */</span>  </span><br><span class="line">	TypeName   *ofTypename;		<span class="comment">/* OF typename  类型名 */</span> </span><br><span class="line">	List	   *constraints;	<span class="comment">/* constraints (list of Constraint nodes)  约束*/</span></span><br><span class="line">	List	   *options;		<span class="comment">/* options from WITH clause    with 语句参数 */</span></span><br><span class="line">	OnCommitAction oncommit;	<span class="comment">/* what do we do at COMMIT? */</span></span><br><span class="line">	<span class="type">char</span>	   *tablespacename; <span class="comment">/* table space to use, or NULL 表空间  */</span></span><br><span class="line">	<span class="type">char</span>	   *accessMethod;	<span class="comment">/* table access method 访问方法  */</span></span><br><span class="line">	<span class="type">bool</span>		if_not_exists;	<span class="comment">/* just do nothing if it already exists? 表是否存在*/</span></span><br><span class="line">&#125; CreateStmt;</span><br></pre></td></tr></table></figure>
<p>该结构用于保存对Create Table
Statement语句查询解析生成的相关信息，如表信息、column列信息列表，访问方法（heap,btree）等</p>
<h1 id="rangevar">RangeVar</h1>
<p>该结构保存SQL语句中from 子句信息，如catalogname/
relname、是否采用别名（alias）和继承关系。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">RangeVar</span></span><br><span class="line">&#123;</span><br><span class="line">	NodeTag		type;</span><br><span class="line">	<span class="type">char</span>	   *catalogname;	<span class="comment">/* the catalog (database) name, or NULL */</span></span><br><span class="line">	<span class="type">char</span>	   *schemaname;		<span class="comment">/* the schema name, or NULL */</span></span><br><span class="line">	<span class="type">char</span>	   *relname;		<span class="comment">/* the relation/sequence name */</span></span><br><span class="line">	<span class="type">bool</span>		inh;			<span class="comment">/* expand rel by inheritance? recursively act</span></span><br><span class="line"><span class="comment">								 * on children? */</span></span><br><span class="line">	<span class="type">char</span>		relpersistence; <span class="comment">/* see RELPERSISTENCE_* in pg_class.h */</span></span><br><span class="line">	Alias	   *alias;			<span class="comment">/* table alias &amp; optional column aliases */</span></span><br><span class="line">	<span class="type">int</span>			location;		<span class="comment">/* token location, or -1 if unknown */</span></span><br><span class="line">&#125; RangeVar;</span><br></pre></td></tr></table></figure>
<h1 id="alias">Alias</h1>
<p>为RangeVar指定别名.别名可能同时重命名了表列.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Alias -</span></span><br><span class="line"><span class="comment"> *    specifies an alias for a range variable; the alias might also</span></span><br><span class="line"><span class="comment"> *    specify renaming of columns within the table.</span></span><br><span class="line"><span class="comment"> *    为RangeVar指定别名.别名可能同时重命名了表列.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note: colnames is a list of Value nodes (always strings).  In Alias structs</span></span><br><span class="line"><span class="comment"> * associated with RTEs, there may be entries corresponding to dropped</span></span><br><span class="line"><span class="comment"> * columns; these are normally empty strings (&quot;&quot;).  See parsenodes.h for info.</span></span><br><span class="line"><span class="comment"> * 注意:colnames是Value节点(通常是字符串)链表.</span></span><br><span class="line"><span class="comment"> *      在与RTEs相关的Alias结构体中,可能有跟已删除的列对应的条目.</span></span><br><span class="line"><span class="comment"> *    这些通常是空字符串(&quot;&quot;).详细可参考parsenodes.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">Alias</span></span><br><span class="line">&#123;</span><br><span class="line">  NodeTag   type;</span><br><span class="line">  <span class="comment">//别名</span></span><br><span class="line">  <span class="type">char</span>     *aliasname;    <span class="comment">/* aliased rel name (never qualified) */</span></span><br><span class="line">  <span class="comment">//列别名链表</span></span><br><span class="line">  List     *colnames;   <span class="comment">/* optional list of column aliases */</span></span><br><span class="line">&#125; Alias;</span><br></pre></td></tr></table></figure>
<h1 id="columndef">ColumnDef</h1>
<p>该结构体保存创建表中的列定义信息，如列名、是否为空、压缩方法、是否定义默认值</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ColumnDef - column definition (used in various creates)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the column has a default value, we may have the value expression</span></span><br><span class="line"><span class="comment"> * in either &quot;raw&quot; form (an untransformed parse tree) or &quot;cooked&quot; form</span></span><br><span class="line"><span class="comment"> * (a post-parse-analysis, executable expression tree), depending on</span></span><br><span class="line"><span class="comment"> * how this ColumnDef node was created (by parsing, or by inheritance</span></span><br><span class="line"><span class="comment"> * from an existing relation).  We should never have both in the same node!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Similarly, we may have a COLLATE specification in either raw form</span></span><br><span class="line"><span class="comment"> * (represented as a CollateClause with arg==NULL) or cooked form</span></span><br><span class="line"><span class="comment"> * (the collation&#x27;s OID).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The constraints list may contain a CONSTR_DEFAULT item in a raw</span></span><br><span class="line"><span class="comment"> * parsetree produced by gram.y, but transformCreateStmt will remove</span></span><br><span class="line"><span class="comment"> * the item and set raw_default instead.  CONSTR_DEFAULT items</span></span><br><span class="line"><span class="comment"> * should not appear in any subsequent processing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">ColumnDef</span></span><br><span class="line">&#123;</span><br><span class="line">	NodeTag		type;</span><br><span class="line">	<span class="type">char</span>	   *colname;		<span class="comment">/* name of column */</span></span><br><span class="line">	TypeName   *typeName;		<span class="comment">/* type of column */</span></span><br><span class="line">	<span class="type">char</span>	   *compression;	<span class="comment">/* compression method for column */</span></span><br><span class="line">	<span class="type">int</span>			inhcount;		<span class="comment">/* number of times column is inherited */</span></span><br><span class="line">	<span class="type">bool</span>		is_local;		<span class="comment">/* column has local (non-inherited) def&#x27;n */</span></span><br><span class="line">	<span class="type">bool</span>		is_not_null;	<span class="comment">/* NOT NULL constraint specified? */</span></span><br><span class="line">	<span class="type">bool</span>		is_from_type;	<span class="comment">/* column definition came from table type */</span></span><br><span class="line">	<span class="type">char</span>		storage;		<span class="comment">/* attstorage setting, or 0 for default */</span></span><br><span class="line">	Node	   *raw_default;	<span class="comment">/* default value (untransformed parse tree) */</span></span><br><span class="line">	Node	   *cooked_default; <span class="comment">/* default value (transformed expr tree) */</span></span><br><span class="line">	<span class="type">char</span>		identity;		<span class="comment">/* attidentity setting */</span></span><br><span class="line">	RangeVar   *identitySequence;	<span class="comment">/* to store identity sequence name for</span></span><br><span class="line"><span class="comment">									 * ALTER TABLE ... ADD COLUMN */</span></span><br><span class="line">	<span class="type">char</span>		generated;		<span class="comment">/* attgenerated setting */</span></span><br><span class="line">	CollateClause *collClause;	<span class="comment">/* untransformed COLLATE spec, if any */</span></span><br><span class="line">	Oid			collOid;		<span class="comment">/* collation OID (InvalidOid if not set) */</span></span><br><span class="line">	List	   *constraints;	<span class="comment">/* other constraints on column */</span></span><br><span class="line">	List	   *fdwoptions;		<span class="comment">/* per-column FDW options */</span></span><br><span class="line">	<span class="type">int</span>			location;		<span class="comment">/* parse location, or -1 if none/unknown */</span></span><br><span class="line">&#125; ColumnDef;</span><br></pre></td></tr></table></figure>
<h1 id="constraint">Constraint</h1>
<p>该结构体用于保存约束信息，如主键、唯一索引、非空、外键和排他约束等信息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">Constraint</span></span><br><span class="line">&#123;</span><br><span class="line">	NodeTag		type;</span><br><span class="line">	ConstrType	contype;		<span class="comment">/* see above  约束类型 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fields used for most/all constraint types: */</span></span><br><span class="line">	<span class="type">char</span>	   *conname;		<span class="comment">/* Constraint name, or NULL if unnamed 约束名  */</span></span><br><span class="line">	<span class="type">bool</span>		deferrable;		<span class="comment">/* DEFERRABLE?  可延迟 */</span></span><br><span class="line">	<span class="type">bool</span>		initdeferred;	<span class="comment">/* INITIALLY DEFERRED? */</span></span><br><span class="line">	<span class="type">int</span>			location;		<span class="comment">/* token location, or -1 if unknown */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fields used for constraints with expressions (CHECK and DEFAULT): */</span></span><br><span class="line">	<span class="type">bool</span>		is_no_inherit;	<span class="comment">/* is constraint non-inheritable? 不可继承的约束*/</span></span><br><span class="line">	Node	   *raw_expr;		<span class="comment">/* expr, as untransformed parse tree 表达式，作为未转化解析树*/</span></span><br><span class="line">	<span class="type">char</span>	   *cooked_expr;	<span class="comment">/* expr, as nodeToString representation */</span></span><br><span class="line">	<span class="type">char</span>		generated_when; <span class="comment">/* ALWAYS or BY DEFAULT */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fields used for unique constraints (UNIQUE and PRIMARY KEY): */</span></span><br><span class="line">	List	   *keys;			<span class="comment">/* String nodes naming referenced key	 key列</span></span><br><span class="line"><span class="comment">								 * column(s) */</span></span><br><span class="line">	List	   *including;		<span class="comment">/* String nodes naming referenced nonkey  nonkey列</span></span><br><span class="line"><span class="comment">								 * column(s) */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fields used for EXCLUSION constraints: */</span></span><br><span class="line">	List	   *exclusions;		<span class="comment">/* list of (IndexElem, operator name) pairs */</span> </span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fields used for index constraints (UNIQUE, PRIMARY KEY, EXCLUSION): */</span></span><br><span class="line">	List	   *options;		<span class="comment">/* options from WITH clause */</span>   </span><br><span class="line">	<span class="type">char</span>	   *indexname;		<span class="comment">/* existing index to use; otherwise NULL  索引名 */</span></span><br><span class="line">	<span class="type">char</span>	   *indexspace;		<span class="comment">/* index tablespace; NULL for default  索引对应的表空间  */</span></span><br><span class="line">	<span class="type">bool</span>		reset_default_tblspc;	<span class="comment">/* reset default_tablespace prior to</span></span><br><span class="line"><span class="comment">										 * creating the index */</span></span><br><span class="line">	<span class="comment">/* These could be, but currently are not, used for UNIQUE/PKEY: */</span></span><br><span class="line">	<span class="type">char</span>	   *access_method;	<span class="comment">/* index access method; NULL for default  访问方法 */</span></span><br><span class="line">	Node	   *where_clause;	<span class="comment">/* partial index predicate      where子句信息	*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fields used for FOREIGN KEY constraints: */</span></span><br><span class="line">	RangeVar   *pktable;		<span class="comment">/* Primary key table  主键信息  */</span></span><br><span class="line">	List	   *fk_attrs;		<span class="comment">/* Attributes of foreign key    外键属性列表*/</span></span><br><span class="line">	List	   *pk_attrs;		<span class="comment">/* Corresponding attrs in PK table  对应的主键属性*/</span></span><br><span class="line">	<span class="type">char</span>		fk_matchtype;	<span class="comment">/* FULL, PARTIAL, SIMPLE */</span></span><br><span class="line">	<span class="type">char</span>		fk_upd_action;	<span class="comment">/* ON UPDATE action */</span></span><br><span class="line">	<span class="type">char</span>		fk_del_action;	<span class="comment">/* ON DELETE action */</span></span><br><span class="line">	List	   *old_conpfeqop;	<span class="comment">/* pg_constraint.conpfeqop of my former self */</span></span><br><span class="line">	Oid			old_pktable_oid;	<span class="comment">/* pg_constraint.confrelid of my former</span></span><br><span class="line"><span class="comment">									 * self */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fields used for constraints that allow a NOT VALID specification */</span></span><br><span class="line">	<span class="type">bool</span>		skip_validation;	<span class="comment">/* skip validation of existing rows? */</span></span><br><span class="line">	<span class="type">bool</span>		initially_valid;	<span class="comment">/* mark the new constraint as valid? */</span></span><br><span class="line">&#125; Constraint;</span><br><span class="line">-------------------------------------------------------------------------------------</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="title class_">ConstrType</span>			<span class="comment">/* types of constraints */</span></span><br><span class="line">&#123;</span><br><span class="line">	CONSTR_NULL,				<span class="comment">/* not standard SQL, but a lot of people</span></span><br><span class="line"><span class="comment">								 * expect it */</span></span><br><span class="line">	CONSTR_NOTNULL,</span><br><span class="line">	CONSTR_DEFAULT,</span><br><span class="line">	CONSTR_IDENTITY,</span><br><span class="line">	CONSTR_GENERATED,</span><br><span class="line">	CONSTR_CHECK,</span><br><span class="line">	CONSTR_PRIMARY,</span><br><span class="line">	CONSTR_UNIQUE,</span><br><span class="line">	CONSTR_EXCLUSION,</span><br><span class="line">	CONSTR_FOREIGN,</span><br><span class="line">	CONSTR_ATTR_DEFERRABLE,		<span class="comment">/* attributes for previous constraint node */</span></span><br><span class="line">	CONSTR_ATTR_NOT_DEFERRABLE,</span><br><span class="line">	CONSTR_ATTR_DEFERRED,</span><br><span class="line">	CONSTR_ATTR_IMMEDIATE</span><br><span class="line">&#125; ConstrType;</span><br></pre></td></tr></table></figure>
<h1 id="query">Query</h1>
<p>SQL语句完成词法、语法解析生成解析树，后进行查询分析与重写生成查询树，其元素为Query结构体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Query -</span></span><br><span class="line"><span class="comment"> *	  Parse analysis turns all statements into a Query tree</span></span><br><span class="line"><span class="comment"> *	  for further processing by the rewriter and planner.</span></span><br><span class="line"><span class="comment"> * 对解析树进行分析生成查询树，继而供后续重写器和计划器处理</span></span><br><span class="line"><span class="comment"> *	  Utility statements (i.e. non-optimizable statements) have the</span></span><br><span class="line"><span class="comment"> *	  utilityStmt field set, and the rest of the Query is mostly dummy.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *	  Planning converts a Query tree into a Plan tree headed by a PlannedStmt</span></span><br><span class="line"><span class="comment"> *	  node --- the Query structure is not used by the executor.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *  计划器将查询树转变成计划树，其head为 PlannedStmt节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">Query</span></span><br><span class="line">&#123;</span><br><span class="line">	NodeTag		type;</span><br><span class="line"></span><br><span class="line">	CmdType		commandType;	<span class="comment">/* select|insert|update|delete|utility */</span></span><br><span class="line"></span><br><span class="line">	QuerySource querySource;	<span class="comment">/* where did I come from? */</span>		</span><br><span class="line"></span><br><span class="line">	uint64		queryId;		<span class="comment">/* query identifier (can be set by plugins)  query 标识符*/</span> </span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		canSetTag;		<span class="comment">/* do I set the command result tag?  */</span> </span><br><span class="line"></span><br><span class="line">	Node	   *utilityStmt;	<span class="comment">/* non-null if commandType == CMD_UTILITY */</span>  </span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>			resultRelation; <span class="comment">/* rtable index of target relation for </span></span><br><span class="line"><span class="comment">								 * INSERT/UPDATE/DELETE; 0 for SELECT */</span> </span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		hasAggs;		<span class="comment">/* has aggregates in tlist or havingQual  agg */</span> </span><br><span class="line">	<span class="type">bool</span>		hasWindowFuncs; <span class="comment">/* has window functions in tlist  是否有窗口函数 */</span></span><br><span class="line">	<span class="type">bool</span>		hasTargetSRFs;	<span class="comment">/* has set-returning functions in tlist   是否设有returning functions */</span></span><br><span class="line">	<span class="type">bool</span>		hasSubLinks;	<span class="comment">/* has subquery SubLink 子查询链  */</span></span><br><span class="line">	<span class="type">bool</span>		hasDistinctOn;	<span class="comment">/* distinctClause is from DISTINCT ON  是否有distinct子句 */</span></span><br><span class="line">	<span class="type">bool</span>		hasRecursive;	<span class="comment">/* WITH RECURSIVE was specified */</span></span><br><span class="line">	<span class="type">bool</span>		hasModifyingCTE;	<span class="comment">/* has INSERT/UPDATE/DELETE in WITH */</span></span><br><span class="line">	<span class="type">bool</span>		hasForUpdate;	<span class="comment">/* FOR [KEY] UPDATE/SHARE was specified 是否指定for update */</span></span><br><span class="line">	<span class="type">bool</span>		hasRowSecurity; <span class="comment">/* rewriter has applied some RLS policy */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		isReturn;		<span class="comment">/* is a RETURN statement  return 查询*/</span></span><br><span class="line"></span><br><span class="line">	List	   *cteList;		<span class="comment">/* WITH list (of CommonTableExpr&#x27;s) */</span></span><br><span class="line"></span><br><span class="line">	List	   *rtable;			<span class="comment">/* list of range table entries 范围表项 */</span></span><br><span class="line">	FromExpr   *jointree;		<span class="comment">/* table join tree (FROM and WHERE clauses) join tree */</span></span><br><span class="line"></span><br><span class="line">	List	   *targetList;		<span class="comment">/* target list (of TargetEntry) 投影列表*/</span></span><br><span class="line"></span><br><span class="line">	OverridingKind <span class="keyword">override</span>;	<span class="comment">/* OVERRIDING clause */</span></span><br><span class="line"></span><br><span class="line">	OnConflictExpr *onConflict; <span class="comment">/* ON CONFLICT DO [NOTHING | UPDATE] 冲突*/</span></span><br><span class="line"></span><br><span class="line">	List	   *returningList;	<span class="comment">/* return-values list (of TargetEntry) 返回链表*/</span></span><br><span class="line"></span><br><span class="line">	List	   *groupClause;	<span class="comment">/* a list of SortGroupClause&#x27;s */</span></span><br><span class="line">	<span class="type">bool</span>		groupDistinct;	<span class="comment">/* is the group by clause distinct? */</span></span><br><span class="line"></span><br><span class="line">	List	   *groupingSets;	<span class="comment">/* a list of GroupingSet&#x27;s if present */</span></span><br><span class="line"></span><br><span class="line">	Node	   *havingQual;		<span class="comment">/* qualifications applied to groups */</span></span><br><span class="line"></span><br><span class="line">	List	   *windowClause;	<span class="comment">/* a list of WindowClause&#x27;s */</span></span><br><span class="line"></span><br><span class="line">	List	   *distinctClause; <span class="comment">/* a list of SortGroupClause&#x27;s */</span></span><br><span class="line"></span><br><span class="line">	List	   *sortClause;		<span class="comment">/* a list of SortGroupClause&#x27;s */</span></span><br><span class="line"></span><br><span class="line">	Node	   *limitOffset;	<span class="comment">/* # of result tuples to skip (int8 expr)  偏移*/</span></span><br><span class="line">	Node	   *limitCount;		<span class="comment">/* # of result tuples to return (int8 expr) 计数*/</span></span><br><span class="line">	LimitOption limitOption;	<span class="comment">/* limit type */</span></span><br><span class="line"></span><br><span class="line">	List	   *rowMarks;		<span class="comment">/* a list of RowMarkClause&#x27;s */</span></span><br><span class="line"></span><br><span class="line">	Node	   *setOperations;	<span class="comment">/* set-operation tree if this is top level of</span></span><br><span class="line"><span class="comment">								 * a UNION/INTERSECT/EXCEPT query */</span></span><br><span class="line"></span><br><span class="line">	List	   *constraintDeps; <span class="comment">/* a list of pg_constraint OIDs that the query</span></span><br><span class="line"><span class="comment">								 * depends on to be semantically valid */</span></span><br><span class="line"></span><br><span class="line">	List	   *withCheckOptions;	<span class="comment">/* a list of WithCheckOption&#x27;s (added</span></span><br><span class="line"><span class="comment">									 * during rewrite) */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The following two fields identify the portion of the source text string</span></span><br><span class="line"><span class="comment">	 * containing this query.  They are typically only populated in top-level</span></span><br><span class="line"><span class="comment">	 * Queries, not in sub-queries.  When not set, they might both be zero, or</span></span><br><span class="line"><span class="comment">	 * both be -1 meaning &quot;unknown&quot;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span>			stmt_location;	<span class="comment">/* start location, or -1 if unknown */</span></span><br><span class="line">	<span class="type">int</span>			stmt_len;		<span class="comment">/* length in bytes; 0 means &quot;rest of string&quot; */</span></span><br><span class="line">&#125; Query;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="plannedstmt">PlannedStmt</h1>
<p>计划器会对上述的查询树进一步处理生成计划树</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ----------------</span></span><br><span class="line"><span class="comment"> *		PlannedStmt node</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The output of the planner is a Plan tree headed by a PlannedStmt node.</span></span><br><span class="line"><span class="comment"> * PlannedStmt holds the &quot;one time&quot; information needed by the executor.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 计划器对此处理生成一个头部为 PlannedStmt node 计划树  </span></span><br><span class="line"><span class="comment"> * DDL语句其 commandType == CMD_UTILITY</span></span><br><span class="line"><span class="comment"> * For simplicity in APIs, we also wrap utility statements in PlannedStmt</span></span><br><span class="line"><span class="comment"> * nodes; in such cases, commandType == CMD_UTILITY, the statement itself</span></span><br><span class="line"><span class="comment"> * is in the utilityStmt field, and the rest of the struct is mostly dummy.</span></span><br><span class="line"><span class="comment"> * (We do use canSetTag, stmt_location, stmt_len, and possibly queryId.)</span></span><br><span class="line"><span class="comment"> * ----------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">PlannedStmt</span></span><br><span class="line">&#123;</span><br><span class="line">	NodeTag		type;</span><br><span class="line"></span><br><span class="line">	CmdType		commandType;	<span class="comment">/* select|insert|update|delete|utility */</span> </span><br><span class="line"></span><br><span class="line">	uint64		queryId;		<span class="comment">/* query identifier (copied from Query) */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		hasReturning;	<span class="comment">/* is it insert|update|delete RETURNING? */</span> </span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		hasModifyingCTE;	<span class="comment">/* has insert|update|delete in WITH? */</span></span><br><span class="line"> </span><br><span class="line">	<span class="type">bool</span>		canSetTag;		<span class="comment">/* do I set the command result tag? */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		transientPlan;	<span class="comment">/* redo plan when TransactionXmin changes? */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		dependsOnRole;	<span class="comment">/* is plan specific to current role? */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>		parallelModeNeeded; <span class="comment">/* parallel mode required to execute?  是否为并行模式 */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span>			jitFlags;		<span class="comment">/* which forms of JIT should be performed  JIT 执行形式  */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">Plan</span> *planTree;		<span class="comment">/* tree of Plan nodes */</span>  <span class="comment">// plan nodes树</span></span><br><span class="line"></span><br><span class="line">	List	   *rtable;			<span class="comment">/* list of RangeTblEntry nodes */</span>  <span class="comment">// 范围链表</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* rtable indexes of target relations for INSERT/UPDATE/DELETE */</span></span><br><span class="line">	List	   *resultRelations;	<span class="comment">/* integer list of RT indexes, or NIL */</span>  <span class="comment">// 范围表索引</span></span><br><span class="line"></span><br><span class="line">	List	   *appendRelations;	<span class="comment">/* list of AppendRelInfo nodes */</span> </span><br><span class="line"></span><br><span class="line">	List	   *subplans;		<span class="comment">/* Plan trees for SubPlan expressions; note</span></span><br><span class="line"><span class="comment">								 * that some could be NULL */</span></span><br><span class="line"></span><br><span class="line">	Bitmapset  *rewindPlanIDs;	<span class="comment">/* indices of subplans that require REWIND */</span></span><br><span class="line"></span><br><span class="line">	List	   *rowMarks;		<span class="comment">/* a list of PlanRowMark&#x27;s */</span></span><br><span class="line"></span><br><span class="line">	List	   *relationOids;	<span class="comment">/* OIDs of relations the plan depends on */</span> <span class="comment">// relation oid</span></span><br><span class="line"></span><br><span class="line">	List	   *invalItems;		<span class="comment">/* other dependencies, as PlanInvalItems */</span> </span><br><span class="line"></span><br><span class="line">	List	   *paramExecTypes; <span class="comment">/* type OIDs for PARAM_EXEC Params */</span> </span><br><span class="line"></span><br><span class="line">	Node	   *utilityStmt;	<span class="comment">/* non-null if this is utility stmt */</span> </span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* statement location in source string (copied from Query) */</span></span><br><span class="line">	<span class="type">int</span>			stmt_location;	<span class="comment">/* start location, or -1 if unknown */</span></span><br><span class="line">	<span class="type">int</span>			stmt_len;		<span class="comment">/* length in bytes; 0 means &quot;rest of string&quot; */</span></span><br><span class="line">&#125; PlannedStmt;</span><br></pre></td></tr></table></figure>
<h1 id="流程图及讲解">流程图及讲解</h1>
<figure>
<img
src="https://img-blog.csdnimg.cn/54613b5533824e7eb4fd077c9e81fd65.png#pic_center"
alt="建表流程图" />
<figcaption aria-hidden="true">建表流程图</figcaption>
</figure>
<p>transformCreateStmt函数是表创建真正的入口函数，其执行流程如下：</p>
<figure>
<img
src="https://img-blog.csdnimg.cn/bee6a79d047344b980c9f7e776528112.png#pic_center"
alt="在这里插入图片描述" />
<figcaption aria-hidden="true">在这里插入图片描述</figcaption>
</figure>
<p>物理文件的创建以及系统表元数据等更新由DefineRelation函数实现：</p>
<figure>
<img
src="https://img-blog.csdnimg.cn/9731ba160532430eb761c1861afde93c.png#pic_center"
alt="在这里插入图片描述" />
<figcaption aria-hidden="true">在这里插入图片描述</figcaption>
</figure>
<h2 id="transformcreatestmt">transformCreateStmt</h2>
<p>该函数对生成的计划树解析分析，返回操作节点链表</p>
<p>执行流程： 1）获取并检查命名空间权限；
2）构建并初始化CreateStmtContext上下文，在后续执行过程中进一步更新relation、约束、列属性等信息。
3）遍历表中所有的列，调用相应的处理函数获取列的属性、约束等信息，填充CreateStmtContext对应字段信息&lt;普通列调用
transformColumnDefinition， 含有约束的调用 transformTableConstraint
&gt;。 4）后续进行预处理，检查约束合理性，最后返回
utility命令的操作节点链表。</p>
<h2 id="definerelation">DefineRelation</h2>
<p>该函数的功能是创建新的relation，包括物理文件、相应的内存relcache
Entry和系统表元数据的更新
1）首先进行权限检查，确定当前用户是否有权限创建表；
2）对创建表语句中的WITH子句进行解析（transformRelOptions）；
3）调用heap_reloptions对参数进行合法验证。 4）调用 MergeAttributes
将继承的属性合并到表属性定义中； 5）根据表列信息调用
BuildDescForRelation函数生成元组描述符TupleDesc，该结构体记录了元组每列字段的详细信息（pg_attribute）
6）遍历定义链表中的每一个属性查看是否有默认值、压缩等信息；
7）在上述条件准备完善下调用
heap_create_with_catalog创建物理文件并在系统表中注册； 8）调用
AddRelationNewConstraints 处理表中新增的约束与默认值</p>
<h2 id="heap_create_with_catalog">heap_create_with_catalog</h2>
<p>1）首先进行参数校验检查，在同一命名空间是否存在相同名、pg_type系统表是否存在相同typename等；
2）调用 GetNewRelFileNode为此表分配一个全局唯一对象标识符Oid;</p>
<ol start="3" type="1">
<li>结合表名、命名空间、对象标识符OID以及元组描述符等信息调用
heap_create 创建一个Relation 结构放入RelCache,后续根据此信息
table_relation_set_new_filenode（Relation）/
RelationCreateStorage(Index)创建物理文件。 4）紧接着调用
AddNewRelationType向pg_type系统表中注册该表的记录；
5）AddNewRelationTuple向pg_class 系统表中插入该表的相关信息；
6）AddNewAttributeTuples 将该表每个字段信息填充值 pg_attribute系统表；
7）最后通过 StoreConstraints 将约束和默认值等信息存储至
pg_constraint和pg_attrdef系统表中。</li>
</ol>
<h2 id="heap_create">heap_create</h2>
<figure>
<img
src="https://img-blog.csdnimg.cn/aa22e495290b48cca4397b04558b98c8.png#pic_center"
alt="在这里插入图片描述" />
<figcaption aria-hidden="true">在这里插入图片描述</figcaption>
</figure>
<p>1）首先进行安全性检查，不允许在系统表中创建relations，判断是否需要创建持久化文件等；
2）根据表名、表空间、表对象标识符和文件节点relfilenode等信息调用
RelationBuildLocalRelation在内存中构建Relation，并插入全局relcache
哈希表中；
3）结合relation类型调用相应的接口函数进行relation的创建，[普通表/TOAST/物化视图:
table_relation_set_new_filenode，索引/序列：RelationCreateStorage];</p>
<p>对于无需创建持久化的relation且用户指定表空间，则需要在 pg_tablespace
中注册对应的信息。</p>
<h2 id="relationbuildlocalrelation">RelationBuildLocalRelation</h2>
<p>该函数目的是在内存中构建创建表的relcache Entry，并插入全局Relcache
哈希表中，用于加速后续对此表的访问。
1）如果不存在CacheMemoryContext，则创建此上下文，后续操作均在此上下文进行；
2）分配并初始化Relation结构体，结合入参的TueDesc填充Relation结构体中rd_att字段：字段属性的详细信息；
3）分配并根据入参填充Relation结构体中rd_att字段的Form_pg_class字段：表名、命名空间、字段属性/数目等；
4）调用 RelationInitLockInfo初始化relation描述符锁信息； 5）调用
RelationInitPhysicalAddr
初始化relation描述符对应的物理地址：spcNode/dbNode//RelNode
[表空间/数据库/表] 6）将上述构建好的RelCache Entry插入全局ralcache
哈希表中，并增加该条目的引用计数</p>
<figure>
<img
src="https://img-blog.csdnimg.cn/f9bf4f64d38c421fb3278cc251816008.png#pic_center"
alt="在这里插入图片描述" />
<figcaption aria-hidden="true">在这里插入图片描述</figcaption>
</figure>
<h2 id="relationcreatestorage">RelationCreateStorage</h2>
<p>物理文件的创建由磁盘管理器负责，pg中所有文件系统均调用这统一接口，而RelationCreateStorage
函数的实现就是通过调用这些函数进一步封装而成，期执行流程如下：
1）对于持久化的relation，设置字段表示need_wal，表明需要写WAL日志，对于临时relation或者unlogged
relation无需此操作； 2）根据输入的RelFileNode调用 smgropen返回
SMgrRelation对象，不存在会创建一个； 3）结合上述返回的
SMgrRelation和ForkNumber号调用 smgrcreate创建relation的物理文件；
4）如需写WAL日志，调用
log_smgrcreate函数记录下此relation的实际物理信息；
5）最后将其添加至PendingRelDelete链表尾，在事务真正提交的时候如需回滚则可通过此信息将创建的文件删除，并返回
SMgrRelation对象。</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/06/27/openGauss/postgresql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8B%93%E5%B1%95pageinspect/" rel="prev" title="postgreSQL中使用pageinspect拓展">
                  <i class="fa fa-chevron-left"></i> postgreSQL中使用pageinspect拓展
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/06/27/openGauss/centos7.6%E5%AE%89%E8%A3%85postgresql9.2/" rel="next" title="centos7.6安装postreSQL9.2">
                  centos7.6安装postreSQL9.2 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">singheart</span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"xinjiempolde","repo":"xinjiempolde.github.io","client_id":"89019d63999840fdbf7f","client_secret":"48d2133d88acfafada6414ec6eee5a9d9febcbc8","admin_user":"xinjiempolde","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"dc5d47c439b4eb841fe7f544295a8036"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false});</script></body>
</html>
